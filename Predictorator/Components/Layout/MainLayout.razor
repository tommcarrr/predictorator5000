@implements IDisposable
@using Predictorator.Components.Pages.Subscription
@inherits LayoutComponentBase
@inject IHttpContextAccessor HttpContextAccessor
@inject ThemeService ThemeService
@inject IDialogService DialogService
<MudLayout>
    <MudThemeProvider @rendermode="InteractiveServer"
                      IsDarkMode="@ThemeService.IsDarkMode"
                      IsDarkModeChanged="@ThemeService.SetDarkModeAsync" />

    <MudPopoverProvider  @rendermode="InteractiveServer" />
    <MudDialogProvider    @rendermode="InteractiveServer" />
    <MudSnackbarProvider  @rendermode="InteractiveServer" />
    <MudAppBar Elevation="1" Color="Color.Primary">
        <MudText Typo="Typo.h5" Class="ml-2">Predictotronix</MudText>
        <MudSpacer />
        @if (HttpContextAccessor.HttpContext?.User.Identity?.IsAuthenticated == true &&
            HttpContextAccessor.HttpContext.User.IsInRole("Admin"))
        {
            <MudButton Variant="Variant.Text" Href="/Admin/SendNotification">Admin</MudButton>
        }
        <MudButton Variant="Variant.Text" OnClick="@OpenSubscribe">Subscribe</MudButton>
        <MudIconButton Icon="@(ThemeService.IsDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                       OnClick="@ToggleDarkMode"
                       UserAttributes="@(new Dictionary<string, object>{{"id","darkModeToggle"}})" />
    </MudAppBar>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.Large">
            @Body
        </MudContainer>
    </MudMainContent>

</MudLayout>

@code {
    protected override void OnInitialized()
    {
        ThemeService.OnChange += OnThemeChanged;
    }

    private async Task ToggleDarkMode()
    {
        await ThemeService.ToggleDarkModeAsync();
    }

    private void OpenSubscribe()
    {
        DialogService.Show<Subscribe>("Subscribe");
    }

    private void OnThemeChanged() => InvokeAsync(StateHasChanged);

    public void Dispose()
    {
        ThemeService.OnChange -= OnThemeChanged;
    }
}
